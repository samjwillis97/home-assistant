id: "5a3d6a60-86ab-408b-b6db-c5a053281a34"
alias: "House: Mode Control"
description: >-
  This is used to control the `input_select` for the state of the house, it can then be used by other automations to make decisions against.
mode: queued
trace:
  stored_traces: 25

triggers:
  - platform: homeassistant
    event: start

  - platform: event
    event_type:
      - automation_reloaded

  # Every hour
  - platform: time_pattern
    hours: /1
    minutes: 0

  # Every 30 minute
  - platform: time_pattern
    minutes: /30

  - id: apple_tv_off
    platform: state
    entity_id:
      - media_player.lounge_room
    to: "off"

  - id: house_away_turned_off
    platform: state
    entity_id:
      - input_boolean.house_mode_away
    to: "off"

variables:
  anchors:
    - &turn_on_bedtime_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "bedtime"

    - &turn_on_work_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "work"

    - &turn_on_wakeup_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "wake up"

    - &turn_on_relaxation_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "relaxation"

    - &turn_on_dinner_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "dinner"

    - &turn_on_sleep_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "sleep"

    - &turn_on_default_mode
      service: input_select.select_option
      target:
        entity_id: input_select.house_mode
      data:
        option: "default"

action:
  - choose:
      # This just means if the house is already in away do not change it.
      # Or because bedtime is only triggered via apple TV turning off, we don't want to switch it automatically
      - alias: "Do nothing (away or bedtime)"
        conditions:
          or:
            - alias: "House mode Away already on"
              condition: state
              entity_id: input_select.house_mode
              state: "away"
            - alias: "House mode bedtime on"
              condition: state
              entity_id: input_select.house_mode
              state: "bedtime"
        sequence: []

      # Bedtime mode turned on when apple TV turned off at night
      - alias: "Turn on Bedtime house mode"
        conditions:
          - alias: "Time 2100 -> 0300"
            condition: time
            after: "21:00:00"
            before: "00:00:00"
          - alias: "Apple TV turned off"
            condition: trigger
            id: apple_tv_off
        sequence:
          <<: *turn_on_bedtime_mode

      - alias: "Relaxation mode handling"
        conditions:
          - alias: "Time after 2000"
            condition: time
            after: "20:00:00"
        sequence:
          <<: *turn_on_relaxation_mode

      - alias: "Dinner mode handling"
        conditions:
          - alias: "Time after 1800"
            condition: time
            after: "18:00:00"
        sequence:
          <<: *turn_on_dinner_mode

      - alias: "Default mode handling"
        conditions:
          - alias: "Time 0900 -> 1800 Weekends"
            condition: time
            after: "09:00:00"
            before: "18:00:00"
            weekday:
              - sat
              - sun
        sequence:
          <<: *turn_on_default_mode

      - alias: "Work mode handling"
        conditions:
          - alias: "Time 0800 -> 1700 Weekdays"
            condition: time
            after: "08:00:00"
            before: "17:00:00"
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
        sequence:
          <<: *turn_on_work_mode

      - alias: "Wake-up mode handling"
        conditions:
          or:
            - alias: "Time 0600 -> 0800 Weekdays"
              condition: time
              after: "06:00:00"
              before: "08:00:00"
              weekday:
                - mon
                - tue
                - wed
                - thu
                - fri
            - alias: "Time 0700 -> 0900 Weekends"
              condition: time
              after: "07:00:00"
              before: "09:00:00"
              weekday:
                - sat
                - sun
        sequence:
          <<: *turn_on_wakeup_mode

      # Always sleep mode after 2AM before 7AM
      - alias: "Sleep mode handling"
        conditions:
          - alias: "Time after 0200 if it reaches this point"
            condition: time
            after: "02:00:00"
            before: "07:00:00"
        sequence:
          <<: *turn_on_sleep_mode

    default:
      <<: *turn_on_default_mode
